<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grimório do Guardião | Protocolo de Evolução</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Crimson+Text:ital,wght@0,400;0,600;0,700;1,400&family=Cinzel:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        :root {
            --color-crimson: #7f1d1d;
            --color-gold: #d4af37;
            --color-dark: #0a0a0a;
            --glass: rgba(10, 10, 10, 0.85);
            --glass-light: rgba(20, 20, 20, 0.6);
        }

        body {
            font-family: 'Crimson Text', serif;
            background-color: var(--color-dark);
            color: #e5e5e5;
            overflow-x: hidden;
            margin: 0;
        }

        h1, h2, h3, .cinzel { font-family: 'Cinzel', serif; }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #0a0a0a; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }

        /* Misticismo UI */
        .mystic-card {
            background: var(--glass);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(212, 175, 55, 0.15);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.6);
            transition: all 0.3s ease;
        }
        
        .active-tab {
            background: rgba(127, 29, 29, 0.3);
            border-color: var(--color-gold);
            color: var(--color-gold);
            box-shadow: 0 0 15px rgba(212, 175, 55, 0.2);
        }

        .inactive-tab {
            opacity: 0.6;
            border-color: transparent;
        }
        .inactive-tab:hover { opacity: 1; background: rgba(255,255,255,0.05); }

        .checkbox-container input:checked + div {
            background-color: #450a0a;
            border-color: #d4af37;
        }

        /* Linha de Reset Point */
        .reset-line {
            display: flex;
            align-items: center;
            text-align: center;
            color: #555;
            margin: 2rem 0;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }
        .reset-line::before, .reset-line::after {
            content: '';
            flex: 1;
            border-bottom: 1px solid #333;
        }
        .reset-line:not(:empty)::before { margin-right: .5em; }
        .reset-line:not(:empty)::after { margin-left: .5em; }

        #canvas-container {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: -1; opacity: 0.5;
        }

        /* Calendário */
        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #222;
            font-size: 0.8rem;
            position: relative;
            transition: all 0.2s;
        }
        .day-gold { background: rgba(212, 175, 55, 0.2); border-color: #d4af37; color: #d4af37; }
        .day-crimson { background: rgba(127, 29, 29, 0.2); border-color: #7f1d1d; color: #f87171; }
        .day-neutral { background: rgba(255, 255, 255, 0.02); }
    </style>
</head>
<body class="min-h-screen text-gray-200 pb-20">

    <div id="canvas-container"></div>

    <div class="relative z-10 container mx-auto px-4 py-6 max-w-3xl">
        
        <!-- Header Compacto -->
        <header class="flex justify-between items-center mb-6 border-b border-gray-800 pb-4">
            <div>
                <h1 class="text-2xl md:text-3xl font-bold text-gray-100 cinzel text-shadow">Grimório do Guardião</h1>
                <p class="text-xs text-amber-500 tracking-widest uppercase">Protocolo de Evolução</p>
            </div>
            <div class="text-right">
                <div class="text-xs text-gray-500 uppercase tracking-widest mb-1">Mana Acumulada</div>
                <div class="flex items-center justify-end gap-2 text-xl font-mono text-gold">
                    <i data-lucide="coins" class="w-4 h-4 text-yellow-500"></i>
                    <input type="number" id="savings-input" placeholder="0" class="bg-transparent text-right w-20 focus:outline-none focus:border-b border-gray-600" onchange="saveSavings(this.value)">
                </div>
            </div>
        </header>

        <!-- Navegação de Abas (Fases e Calendário) -->
        <nav class="grid grid-cols-4 gap-2 mb-6">
            <button onclick="switchTab('month1')" id="tab-month1" class="mystic-card py-3 px-1 rounded-lg text-center text-xs md:text-sm font-bold uppercase transition-all inactive-tab">
                <span class="block text-xl mb-1">I</span>
                Fundação
            </button>
            <button onclick="switchTab('month2')" id="tab-month2" class="mystic-card py-3 px-1 rounded-lg text-center text-xs md:text-sm font-bold uppercase transition-all inactive-tab">
                <span class="block text-xl mb-1">II</span>
                Território
            </button>
            <button onclick="switchTab('month3')" id="tab-month3" class="mystic-card py-3 px-1 rounded-lg text-center text-xs md:text-sm font-bold uppercase transition-all inactive-tab">
                <span class="block text-xl mb-1">III</span>
                Caçador
            </button>
            <button onclick="switchTab('calendar')" id="tab-calendar" class="mystic-card py-3 px-1 rounded-lg text-center text-xs md:text-sm font-bold uppercase transition-all inactive-tab">
                <i data-lucide="calendar" class="mx-auto mb-1 w-5 h-5"></i>
                Histórico
            </button>
        </nav>

        <!-- Conteúdo Principal: Checklist Diário -->
        <div id="view-daily" class="animate-fade-in">
            
            <!-- Explicação da Fase Atual -->
            <div class="mystic-card p-4 mb-6 rounded-lg bg-black/40 border-l-4 border-amber-600">
                <h3 id="phase-title" class="text-amber-500 font-bold cinzel text-lg">Mês 1: A Fundação</h3>
                <p id="phase-desc" class="text-sm text-gray-400 italic mt-1">
                    "Eu sou um observador." Foco absoluto em Sono e Meditação. O resto é secundário.
                </p>
            </div>

            <!-- Barra de Progresso Diária -->
            <div class="mb-6">
                <div class="flex justify-between text-xs uppercase tracking-widest mb-1 text-gray-500">
                    <span>Sincronia Diária</span>
                    <span id="progress-text">0%</span>
                </div>
                <div class="w-full bg-gray-900 rounded-full h-2">
                    <div id="progress-bar" class="bg-amber-700 h-2 rounded-full transition-all duration-500 w-0"></div>
                </div>
            </div>

            <!-- Lista de Tarefas (Gerada via JS) -->
            <div id="task-list" class="space-y-4 pb-20"></div>
        </div>

        <!-- Conteúdo Secundário: Calendário -->
        <div id="view-calendar" class="hidden animate-fade-in">
            <div class="mystic-card p-6 rounded-xl">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl cinzel text-gray-200" id="cal-month-name">Calendário</h2>
                    <div class="flex gap-2 text-xs">
                        <span class="flex items-center gap-1"><div class="w-3 h-3 bg-amber-900/40 border border-amber-500"></div> Digerido</span>
                        <span class="flex items-center gap-1"><div class="w-3 h-3 bg-red-900/40 border border-red-800"></div> Falha</span>
                    </div>
                </div>
                <div id="calendar-grid" class="grid grid-cols-7 gap-2">
                    <!-- Dias gerados via JS -->
                </div>
                
                <div class="mt-8 border-t border-gray-800 pt-4 text-center">
                    <h3 class="cinzel text-amber-600 mb-2">Análise Semanal (Reality Anchor)</h3>
                    <textarea id="weekly-journal" placeholder="Onde eu perdi o controle? Onde eu venci? Escreva brevemente..." class="w-full bg-black/30 border border-gray-700 rounded p-3 text-sm text-gray-300 focus:border-amber-500 outline-none h-32"></textarea>
                </div>
            </div>
        </div>

    </div>

    <!-- Floating Action Button: Emergency -->
    <div class="fixed bottom-6 right-6 z-50">
        <button onclick="openBreathing()" class="bg-red-900/80 hover:bg-red-800 text-white p-4 rounded-full shadow-[0_0_20px_rgba(220,38,38,0.4)] border border-red-500 transition-transform hover:scale-105 group">
            <i data-lucide="skull" class="w-6 h-6"></i>
            <span class="absolute right-full mr-3 top-2 bg-black/90 px-2 py-1 rounded text-xs whitespace-nowrap opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none border border-red-900">Perda de Controle?</span>
        </button>
    </div>

    <!-- Modal de Respiração -->
    <div id="breathing-modal" class="fixed inset-0 z-[60] flex items-center justify-center bg-black/95 hidden opacity-0 transition-opacity duration-500">
        <div class="text-center">
            <div class="breathing-circle w-48 h-48 border-4 border-amber-500 rounded-full mx-auto mb-8 shadow-[0_0_50px_rgba(212,175,55,0.3)] animate-pulse"></div>
            <p class="text-2xl cinzel text-gray-300 mb-8">Inspire... Expire...</p>
            <button onclick="closeBreathing()" class="text-gray-500 hover:text-white border-b border-transparent hover:border-white transition-all">Estou Estável</button>
        </div>
    </div>

    <script>
        // --- CONFIGURAÇÃO DO ACTING METHOD ---

        // Definição das Fases e suas regras de inclusão
        // minPhase: 1 = Mês 1, 2 = Mês 2, etc.
        const tasksDatabase = [
            // MANHÃ
            { id: 'm_sun', text: 'Luz Solar Imediata (Reset Ciclo)', turn: 'morning', minPhase: 1 },
            { id: 'm_meditate', text: 'Meditação do Observador (5min)', turn: 'morning', minPhase: 1 },
            { id: 'm_water', text: 'Água Gelada (Choque Térmico)', turn: 'morning', minPhase: 1 },
            { id: 'm_bed', text: 'Arrumar Cama (Ordem Mínima)', turn: 'morning', minPhase: 2 },
            
            // DIA (Trabalho)
            { id: 'd_task', text: 'Tarefas Essenciais (Trabalho)', turn: 'day', minPhase: 1 },
            { id: 'd_lunch', text: 'Almoço: Comer Marmita Própria', turn: 'day', minPhase: 3 },
            { id: 'd_reset', text: 'Reset Point Pós-Almoço (Respiração)', turn: 'day', minPhase: 1 },

            // TARDE (Chegada em Casa)
            { id: 'a_gym_light', text: 'Vestir Roupa de Treino (Só vestir conta)', turn: 'afternoon', minPhase: 1, maxPhase: 2 },
            { id: 'a_gym_hard', text: 'Missão Caçador (Treino Intenso)', turn: 'afternoon', minPhase: 3 },
            { id: 'a_shower', text: 'Ritual de Purificação (Banho Consciente)', turn: 'afternoon', minPhase: 2 },
            { id: 'a_clean_2min', text: 'Regra dos 2 Minutos (Limpeza Rápida)', turn: 'afternoon', minPhase: 2 },

            // NOITE
            { id: 'n_sink', text: 'Pia Limpa (Ambiente Sacro)', turn: 'night', minPhase: 2 },
            { id: 'n_prep', text: 'Preparar Roupa/Mesa p/ Amanhã', turn: 'night', minPhase: 1 },
            { id: 'n_read', text: 'Recompensa: Lord of Mysteries', turn: 'night', minPhase: 1 },
            { id: 'n_screens', text: 'Blackout Digital (1h antes dormir)', turn: 'night', minPhase: 1 },
        ];

        const phaseInfo = {
            month1: {
                title: "Mês 1: A Fundação (O Observador)",
                desc: "Objetivo: Regular o sono e criar a âncora mental. O resto é opcional. Se falhar no treino, tudo bem. Não falhe na meditação.",
                level: 1
            },
            month2: {
                title: "Mês 2: O Território (O Zelador)",
                desc: "Objetivo: O ambiente reflete a mente. Adicionamos higiene e limpeza leve. Pia limpa é lei.",
                level: 2
            },
            month3: {
                title: "Mês 3: O Recipiente (O Caçador)",
                desc: "Objetivo: Intensidade física e controle alimentar. Domingo é dia de Meal Prep.",
                level: 3
            }
        };

        // Estado Global
        let currentPhase = localStorage.getItem('lom_phase') || 'month1';
        let savings = localStorage.getItem('lom_savings') || '';

        // --- INICIALIZAÇÃO ---
        document.addEventListener('DOMContentLoaded', () => {
            loadState();
            switchTab(currentPhase); // Carrega a UI correta
            lucide.createIcons();
            initThree(); // Background 3D
        });

        // --- LÓGICA DE UI ---

        function switchTab(tabId) {
            // Atualizar botões
            document.querySelectorAll('nav button').forEach(b => {
                b.classList.remove('active-tab');
                b.classList.add('inactive-tab');
            });
            document.getElementById(`tab-${tabId}`).classList.add('active-tab');
            document.getElementById(`tab-${tabId}`).classList.remove('inactive-tab');

            // Trocar Views
            const dailyView = document.getElementById('view-daily');
            const calendarView = document.getElementById('view-calendar');

            if (tabId === 'calendar') {
                dailyView.classList.add('hidden');
                calendarView.classList.remove('hidden');
                renderCalendar();
            } else {
                dailyView.classList.remove('hidden');
                calendarView.classList.add('hidden');
                
                // Setar fase atual
                currentPhase = tabId;
                localStorage.setItem('lom_phase', currentPhase);
                renderPhase(tabId);
            }
        }

        function renderPhase(phaseId) {
            const info = phaseInfo[phaseId];
            document.getElementById('phase-title').innerText = info.title;
            document.getElementById('phase-desc').innerText = info.desc;
            
            renderTasks(info.level);
        }

        function renderTasks(level) {
            const container = document.getElementById('task-list');
            container.innerHTML = '';
            
            const savedChecks = getDailyChecks();
            
            // Agrupar tarefas por turno
            const turns = {
                'morning': 'Turno da Manhã: O Despertar',
                'day': 'Turno do Dia: A Missão',
                'afternoon': 'Turno da Tarde: O Retorno',
                'night': 'Turno da Noite: O Santuário'
            };

            let tasksTotal = 0;
            let tasksDone = 0;

            Object.entries(turns).forEach(([turnKey, turnTitle], index) => {
                // Filtrar tarefas
                const tasks = tasksDatabase.filter(t => 
                    t.turn === turnKey && 
                    t.minPhase <= level && 
                    (!t.maxPhase || t.maxPhase >= level)
                );

                if (tasks.length === 0) return;

                // Adicionar Divisor de Reset Point (exceto no primeiro)
                if (index > 0) {
                    const resetHTML = `
                        <div class="reset-line">
                            <i data-lucide="refresh-ccw" class="w-3 h-3 mr-2"></i>
                            Reset Point (Zerar Culpa)
                        </div>`;
                    container.insertAdjacentHTML('beforeend', resetHTML);
                }

                // Header do Turno
                const sectionHTML = document.createElement('div');
                sectionHTML.className = 'mystic-card p-4 rounded-lg';
                sectionHTML.innerHTML = `<h4 class="text-amber-600 cinzel text-sm border-b border-gray-800 pb-2 mb-3 uppercase tracking-widest">${turnTitle}</h4>`;

                const listDiv = document.createElement('div');
                listDiv.className = 'space-y-3';

                tasks.forEach(task => {
                    tasksTotal++;
                    const isChecked = savedChecks[task.id] ? 'checked' : '';
                    if (isChecked) tasksDone++;

                    const itemHTML = `
                        <label class="checkbox-container flex items-center gap-3 cursor-pointer group">
                            <input type="checkbox" class="hidden" ${isChecked} onchange="toggleTask('${task.id}')">
                            <div class="w-5 h-5 border border-gray-600 rounded bg-gray-900/50 flex items-center justify-center transition-all duration-300 group-hover:border-amber-500 shrink-0">
                                <svg class="w-3 h-3 text-amber-400 opacity-0 transition-all duration-300 transform scale-50" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg>
                            </div>
                            <span class="text-sm text-gray-400 group-hover:text-gray-200 transition-colors select-none">${task.text}</span>
                        </label>
                    `;
                    listDiv.insertAdjacentHTML('beforeend', itemHTML);
                });

                sectionHTML.appendChild(listDiv);
                container.appendChild(sectionHTML);
            });

            // Atualizar barra
            const percent = tasksTotal === 0 ? 0 : Math.round((tasksDone / tasksTotal) * 100);
            document.getElementById('progress-bar').style.width = `${percent}%`;
            document.getElementById('progress-text').innerText = `${percent}%`;
            
            // Salvar percentual do dia para o histórico
            saveDailyHistory(percent);
            update3DState(percent);

            lucide.createIcons();
        }

        // --- LÓGICA DE DADOS ---

        function getTodayKey() {
            return new Date().toISOString().split('T')[0];
        }

        function getDailyChecks() {
            const store = JSON.parse(localStorage.getItem('lom_checks') || '{}');
            const today = getTodayKey();
            if (store.date !== today) {
                return {}; // Novo dia, limpa visualmente (mas não deleta histórico)
            }
            return store.checks || {};
        }

        function toggleTask(taskId) {
            const today = getTodayKey();
            let store = JSON.parse(localStorage.getItem('lom_checks') || '{}');
            
            if (store.date !== today) {
                store = { date: today, checks: {} };
            }

            if (store.checks[taskId]) {
                delete store.checks[taskId];
            } else {
                store.checks[taskId] = true;
            }

            localStorage.setItem('lom_checks', JSON.stringify(store));
            
            // Re-render para atualizar barra e histórico
            const currentLevel = phaseInfo[currentPhase].level;
            renderTasks(currentLevel);
        }

        function saveDailyHistory(percent) {
            const history = JSON.parse(localStorage.getItem('lom_history') || '{}');
            history[getTodayKey()] = percent;
            localStorage.setItem('lom_history', JSON.stringify(history));
        }

        function saveSavings(val) {
            localStorage.setItem('lom_savings', val);
        }

        function loadState() {
            document.getElementById('savings-input').value = savings;
        }

        // --- CALENDÁRIO ---

        function renderCalendar() {
            const grid = document.getElementById('calendar-grid');
            grid.innerHTML = '';
            
            const date = new Date();
            const year = date.getFullYear();
            const month = date.getMonth();
            
            const monthNames = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
            document.getElementById('cal-month-name').innerText = monthNames[month];

            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const firstDayIndex = new Date(year, month, 1).getDay();

            // Espaços vazios antes do dia 1
            for (let i = 0; i < firstDayIndex; i++) {
                grid.innerHTML += `<div class="aspect-square"></div>`;
            }

            const history = JSON.parse(localStorage.getItem('lom_history') || '{}');

            for (let i = 1; i <= daysInMonth; i++) {
                const dayKey = `${year}-${String(month+1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                const score = history[dayKey];
                
                let styleClass = 'day-neutral text-gray-600';
                if (score !== undefined) {
                    if (score >= 80) styleClass = 'day-gold font-bold';
                    else if (score >= 40) styleClass = 'day-neutral text-gray-300';
                    else styleClass = 'day-crimson';
                }

                // Destaque para hoje
                const isToday = dayKey === getTodayKey();
                const borderClass = isToday ? 'border-2 border-white' : '';

                grid.innerHTML += `
                    <div class="calendar-day rounded ${styleClass} ${borderClass}">
                        ${i}
                        ${score !== undefined ? `<div class="absolute bottom-1 right-1 text-[8px] opacity-50">${score}%</div>` : ''}
                    </div>
                `;
            }
            
            // Carregar Journal
            const journal = localStorage.getItem('lom_journal') || '';
            document.getElementById('weekly-journal').value = journal;
            document.getElementById('weekly-journal').onchange = (e) => {
                localStorage.setItem('lom_journal', e.target.value);
            };
        }

        // --- MODAL & EFEITOS ---
        function openBreathing() {
            const modal = document.getElementById('breathing-modal');
            modal.classList.remove('hidden');
            void modal.offsetWidth; modal.classList.remove('opacity-0');
        }
        function closeBreathing() {
            const modal = document.getElementById('breathing-modal');
            modal.classList.add('opacity-0');
            setTimeout(() => modal.classList.add('hidden'), 500);
        }

        // --- THREE.JS BACKGROUND (Simplificado para performance) ---
        let scene, camera, renderer, particles;
        function initThree() {
            const container = document.getElementById('canvas-container');
            scene = new THREE.Scene();
            scene.fog = new THREE.FogExp2(0x0a0a0a, 0.03);
            camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 100);
            camera.position.z = 5;
            renderer = new THREE.WebGLRenderer({alpha:true});
            renderer.setSize(window.innerWidth, window.innerHeight);
            container.appendChild(renderer.domElement);

            // Partículas
            const geo = new THREE.BufferGeometry();
            const counts = 500;
            const pos = new Float32Array(counts*3);
            for(let i=0; i<counts*3; i++) pos[i] = (Math.random()-0.5)*10;
            geo.setAttribute('position', new THREE.BufferAttribute(pos,3));
            const mat = new THREE.PointsMaterial({size:0.03, color:0x555555});
            particles = new THREE.Points(geo, mat);
            scene.add(particles);

            animate();
        }

        let speed = 0.001;
        function animate() {
            requestAnimationFrame(animate);
            particles.rotation.y += speed;
            renderer.render(scene, camera);
        }

        function update3DState(percent) {
            // Acelera as partículas e muda cor baseado no progresso
            speed = 0.001 + (percent * 0.00005);
            if(particles) {
                if(percent > 80) particles.material.color.setHex(0xd4af37); // Gold
                else particles.material.color.setHex(0x555555); // Gray
            }
        }

        window.addEventListener('resize', () => {
            if(camera && renderer) {
                camera.aspect = window.innerWidth/window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            }
        });

    </script>
</body>
</html>